class SS_API_Management{constructor(){this._session="new";this._aid="";this._as="";this._si="";this._sat="";this._srt="";this.wait=false;this.waitForpile=false;this.dns="";this.pile=new Array();this.lastRequest_param={};this.need_reopen_event=true;document.addEventListener('session_update',(e)=>this.UPDATE_PARAMS(e));document.addEventListener('session_should_refresh',(e)=>this.RESEND_with_REFRESH(e))}setlastRequest_param(param){this.lastRequest_param=JSON.stringify(param)}getlastRequest_param(){return JSON.parse(this.lastRequest_param)}LASTPARAM_COMPARE(param){if(JSON.stringify(param)==this.lastRequest_param){return true}else{return false}}setSI(si){this._si=si}getSI(){return this._si}setSAT(sat){this._sat=sat}getSAT(){return this._sat}setSRT(srt){this._srt=srt}getSRT(){return this._srt}setSESSION(session){this._session=session}getSESSION(){return this._session}setAID(aid){return this._aid=aid}getAID(){return this._aid}setAS(as){return this._as=as}getAS(){return this._as}isWAIT(){return this.wait}CONSTRUCT_HEADER(){if(this._session=="new"){this.wait=true;return{"session":"new","appid":this._aid,"app_secret":this._as}}else if(this._session=="linked"){return{"session":"linked","session_id":this._si,"session_access_token":this._sat}}else if(this._session=="refresh"){return{"session":"refresh","session_id":this._si,"session_access_token":this._sat,"session_refresh_token":this._srt}}else{return{}}}EXIST_IN_PILE(param){if(this.LASTPARAM_COMPARE(param)){return true}for(var i=0;i<this.pile.length;i++){if(this.pile[i]==JSON.stringify(param)){return true}}return false}EXEC_PILE(){while(this.pile.length>0){SSAPI.SUBMIT(JSON.parse(this.pile[0]));this.pile.shift()}this.lastRequest_param=""}UPDATE_PARAMS(s){this._si=s.id;this._sat=s.access_token;this._srt=s.refresh_token;this._session="linked";this.wait=false;this.lastRequest_param="";SSAPI.UPDATE(this.getSESSION());this.EXEC_PILE()}RESEND_WITH_REFRESH(param){if(this.wait==true){length=this.pile.length;if(!this.EXIST_IN_PILE(param)){this.pile.push(JSON.stringify(param))}}else{this._session="refresh";SSAPI.SUBMIT(param);this.wait=true;this.lastRequest_param=param}}RESEND_WITH_NEW(param){if(this.wait==true){length=this.pile.length;if(!this.EXIST_IN_PILE(param)){this.pile.push(JSON.stringify(param))}}else{this._session="new";SSAPI.SUBMIT(param);this.wait=true;this.lastRequest_param=JSON.stringify(param)}}SESSION_ERROR(erroCode){if((erroCode>=1100)&&(erroCode<=1120)){return true}else{return false}}SESSION_NEED_REFRESH(erroCode){if(erroCode==1115||erroCode==1120){return true}else{return false}}SESSION_REOPEN(erroCode){if(erroCode==1113||erroCode==1114||erroCode==1116||erroCode==1119||erroCode==1104){return true}else{return false}}SESSION_STOPED_JS(erroCode){if(erroCode==1100||erroCode==1101||erroCode==1102||erroCode==1103||erroCode==1105||erroCode==1109||erroCode==1107||erroCode==1112){return true}else{return false}}SESSION_STOPED_SERVER(erroCode){if(erroCode==1106||erroCode==1108||erroCode==1110||erroCode==1119||erroCode==1111){return true}else{return false}}FALSE_REFRESH(erroCode){if(erroCode==1117){return true}else{return false}}RESOLVE_SESSION(param,erroCode){if(this.SESSION_NEED_REFRESH(erroCode)){this.RESEND_WITH_REFRESH(param)}else if(this.SESSION_REOPEN(erroCode)){this.RESEND_WITH_NEW(param)}else if(this.SESSION_STOPED_JS(erroCode)){console.error("Error code : "+erroCode+" -> verify configuration","Error JS")}else if(this.SESSION_STOPED_SERVER(erroCode)){console.error("Error code : "+erroCode+" -> verify configuration","Error Server")}}EVENTS(name){var event=new CustomEvent(name,{detail:{}});document.dispatchEvent(event)}}let SSAPI_MANAGER=new SS_API_Management();class SSAPI_SENDER{constructor(){$("documemt").ready(function(){SSAPI.INIT()})}INIT(){var dataS={remember:"session",SSAPI_PARAM:"verify"};$.ajax({type:"POST",url:window.location.protocol+"//"+window.location.hostname,data:dataS,dataType:"json",error:function(a){console.error("session error synch");$(".cnx_lost").css("display","inline-block");setTimeout(function(){SSAPI.INIT()},1000)},success:function(a){$(".cnx_lost").css("display","none");var b=a;if(a.isValid){if(a.session=="new"){SSAPI_MANAGER.dns=a.dns;SSAPI_MANAGER.setSESSION(a.session);SSAPI_MANAGER.setAID(a.aid);SSAPI_MANAGER.setAS(a.as)}else{SSAPI_MANAGER.dns=a.dns;SSAPI_MANAGER.setSESSION(a.session);SSAPI_MANAGER.setAID(a.aid);SSAPI_MANAGER.setAS(a.as);SSAPI_MANAGER.setSI(a.si);SSAPI_MANAGER.setSAT(a.sat);SSAPI_MANAGER.setSRT(a.srt)}SSAPI_MANAGER.EVENTS("SSAPI_READY")}}})}UPDATE(param){var dataS={remember:"session",SSAPI_UPDATE_PARAM:param,si:SSAPI_MANAGER.getSI(),sat:SSAPI_MANAGER.getSAT(),srt:SSAPI_MANAGER.getSRT()};$.ajax({type:"POST",url:window.location.protocol+"//"+window.location.hostname,data:dataS,dataType:"json",error:function(a){console.error("session error synch");console.log(a);console.log(dataS);console.log(url);$(".cnx_lost").css("display","inline-block");setTimeout(function(){SSAPI.UPDATE(param)},1000)},success:function(a){$(".cnx_lost").css("display","none");var b=a;if(a.isValid){if(a.session=="new"){SSAPI_MANAGER.setSESSION(a.session);SSAPI_MANAGER.setAID(a.aid);SSAPI_MANAGER.setAS(a.as)}else{SSAPI_MANAGER.setSESSION(a.session);SSAPI_MANAGER.setAID(a.aid);SSAPI_MANAGER.setAS(a.as);SSAPI_MANAGER.setSI(a.si);SSAPI_MANAGER.setSAT(a.sat);SSAPI_MANAGER.setSRT(a.srt)}SSAPI_MANAGER.EVENTS("SSAPI_READY")}}})}REMEMBER_SESSION(param){var dataS={remember:"session",si:SSAPI_MANAGER.getSI(),sat:SSAPI_MANAGER.getSAT(),srt:SSAPI_MANAGER.getSRT()};$.ajax({type:"POST",url:window.location.protocol+"//"+window.location.hostname,data:dataS,dataType:"json",beforeSend:function(){if(param.loading){$("[DATI-ROLE='loading']").show()}},complete:function(a){if(param.loading){$("[DATI-ROLE='loading']").hide()}},error:function(a){console.error("session error synch");$(".cnx_lost").css("display","inline-block");setTimeout(function(){SSAPI.REMEMBER_SESSION(param)},1000);if(param.onerror){SSAPI.EVENTS(param.onerror,{error:"Error synchronisation data, try later",errorCode:100,isValid:0})}},success:function(a){$(".cnx_lost").css("display","none");var b=a;if(b.isValid){if(param.onsuccess){SSAPI_MANAGER.EVENTS(param.onsuccess)}}else{if(param.onerror){SSAPI_MANAGER.EVENTS(param.onerror)}}}})}REMEMBER(param){$.ajax({type:"POST",url:uri,data:data,dataType:"json",beforeSend:function(){if(param.loading){$("[DATI-ROLE='loading']").show()}},complete:function(a){if(param.loading){$("[DATI-ROLE='loading']").hide()}},error:function(a){console.error("session error synch");$(".cnx_lost").css("display","inline-block");setTimeout(function(){SSAPI.REMEMBER(param)},1000)},success:function(a){$(".cnx_lost").css("display","none");if(a.isValid){if(param.onsuccess){SSAPI.EVENTS(param.onsuccess,a)}}else{if(param.onerror){SSAPI.EVENTS(param.onerror,a)}}}})}SUBMIT(param){if(SSAPI_MANAGER.wait){if(!SSAPI_MANAGER.EXIST_IN_PILE(param)){SSAPI_MANAGER.pile.push(JSON.stringify(param))}}else{var headers=SSAPI_MANAGER.CONSTRUCT_HEADER();if(headers.session=="new"){SSAPI_MANAGER.wait=true;SSAPI_MANAGER.setlastRequest_param(param)}SSAPI.SEND(param,headers)}}SEND(param,HEADER){var dataSend=param.data;if(param.method){var method=param.method}else{var method="POST"}var uri=SSAPI_MANAGER.dns+param.uri;$.ajax({type:"POST",url:uri,data:dataSend,dataType:"json",headers:HEADER,beforeSend:function(){if(param.loading){$("[SOWAZI-ROLE='loading']").show()}},complete:function(a){if(param.loading){$("[SOWAZI-ROLE='loading']").hide()}},error:function(a){$(".cnx_lost").css("display","inline-block");SSAPI_MANAGER.EVENTS("ERROR_CONNECTION_SERVER");if(HEADER.session=="new"||HEADER.session=="refresh"){setTimeout(function(){SSAPI.SEND(param,HEADER)},1000)}else{setTimeout(function(){SSAPI.SUBMIT(param)},1000)}},success:function(a){SSAPI_MANAGER.EVENTS("SUCCESS_CONNECTION_SERVER");$(".cnx_lost").css("display","none");if(a.session_updated){SSAPI_MANAGER.UPDATE_PARAMS(a.session)}if(a.isValid){if(param.onsuccess){SSAPI.EVENTS(param.onsuccess,a)}}else{if(!SSAPI_MANAGER.RESOLVE_SESSION(param,a["errorCode"])){if(param.onerror){SSAPI.EVENTS(param.onerror,a)}}}}})}EVENTS(name,data){var event=new CustomEvent(name,{detail:{success:data.isValid,error:data.error,res:data.data}});document.dispatchEvent(event)}}let SSAPI=new SSAPI_SENDER();